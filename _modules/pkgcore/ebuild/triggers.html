
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pkgcore.ebuild.triggers &#8212; pkgcore trunk documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinxdoc.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">pkgcore trunk documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">pkgcore.ebuild.triggers</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for pkgcore.ebuild.triggers</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;gentoo/ebuild specific triggers&quot;&quot;&quot;</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;collapse_envd&quot;</span><span class="p">,</span> <span class="s2">&quot;string_collapse_envd&quot;</span><span class="p">,</span> <span class="s2">&quot;env_update&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ConfigProtectInstall&quot;</span><span class="p">,</span> <span class="s2">&quot;ConfigProtectUninstall&quot;</span><span class="p">,</span> <span class="s2">&quot;preinst_contents_reset&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CollisionProtect&quot;</span><span class="p">,</span> <span class="s2">&quot;ProtectOwned&quot;</span><span class="p">,</span> <span class="s2">&quot;install_into_symdir_protect&quot;</span><span class="p">,</span>
    <span class="s2">&quot;InfoRegen&quot;</span><span class="p">,</span> <span class="s2">&quot;SFPerms&quot;</span><span class="p">,</span> <span class="s2">&quot;FixImageSymlinks&quot;</span><span class="p">,</span> <span class="s2">&quot;GenerateTriggers&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">fnmatch</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">snakeoil.bash</span> <span class="kn">import</span> <span class="n">read_bash_dict</span>
<span class="kn">from</span> <span class="nn">snakeoil.fileutils</span> <span class="kn">import</span> <span class="n">AtomicWriteFile</span>
<span class="kn">from</span> <span class="nn">snakeoil.osutils</span> <span class="kn">import</span> <span class="n">listdir_files</span><span class="p">,</span> <span class="n">normpath</span><span class="p">,</span> <span class="n">pjoin</span>
<span class="kn">from</span> <span class="nn">snakeoil.sequences</span> <span class="kn">import</span> <span class="n">iflatten_instance</span><span class="p">,</span> <span class="n">stable_unique</span>

<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">os_data</span>
<span class="kn">from</span> <span class="nn">..fs</span> <span class="kn">import</span> <span class="n">livefs</span>
<span class="kn">from</span> <span class="nn">..merge</span> <span class="kn">import</span> <span class="n">const</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">triggers</span>
<span class="kn">from</span> <span class="nn">..restrictions</span> <span class="kn">import</span> <span class="n">values</span>
<span class="kn">from</span> <span class="nn">..system</span> <span class="kn">import</span> <span class="n">libtool</span>

<span class="n">colon_parsed</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span>
    <span class="s2">&quot;ADA_INCLUDE_PATH&quot;</span><span class="p">,</span> <span class="s2">&quot;ADA_OBJECTS_PATH&quot;</span><span class="p">,</span> <span class="s2">&quot;INFODIR&quot;</span><span class="p">,</span> <span class="s2">&quot;INFOPATH&quot;</span><span class="p">,</span> <span class="s2">&quot;LDPATH&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MANPATH&quot;</span><span class="p">,</span> <span class="s2">&quot;PATH&quot;</span><span class="p">,</span> <span class="s2">&quot;PYTHONPATH&quot;</span><span class="p">,</span> <span class="s2">&quot;PKG_CONFIG_PATH&quot;</span><span class="p">,</span> <span class="s2">&quot;ROOTPATH&quot;</span>
<span class="p">])</span>

<span class="n">incrementals</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span>
    <span class="s1">&#39;ADA_INCLUDE_PATH&#39;</span><span class="p">,</span> <span class="s1">&#39;ADA_OBJECTS_PATH&#39;</span><span class="p">,</span> <span class="s1">&#39;CLASSPATH&#39;</span><span class="p">,</span> <span class="s1">&#39;CONFIG_PROTECT&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CONFIG_PROTECT_MASK&#39;</span><span class="p">,</span> <span class="s1">&#39;INFODIR&#39;</span><span class="p">,</span> <span class="s1">&#39;INFOPATH&#39;</span><span class="p">,</span> <span class="s1">&#39;KDEDIRS&#39;</span><span class="p">,</span> <span class="s1">&#39;LDPATH&#39;</span><span class="p">,</span>
    <span class="s1">&#39;MANPATH&#39;</span><span class="p">,</span> <span class="s1">&#39;PATH&#39;</span><span class="p">,</span> <span class="s1">&#39;PYTHONPATH&#39;</span><span class="p">,</span> <span class="s1">&#39;ROOTPATH&#39;</span><span class="p">,</span> <span class="s1">&#39;PKG_CONFIG_PATH&#39;</span>
<span class="p">])</span>


<div class="viewcode-block" id="collapse_envd"><a class="viewcode-back" href="../../../api/pkgcore.ebuild.triggers.html#pkgcore.ebuild.triggers.collapse_envd">[docs]</a><span class="k">def</span> <span class="nf">collapse_envd</span><span class="p">(</span><span class="n">base</span><span class="p">):</span>
    <span class="n">collapsed_d</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">env_d_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">listdir_files</span><span class="p">(</span><span class="n">base</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">env_d_files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.bak&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">x</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;._cfg&quot;</span><span class="p">)</span> \
                    <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">read_bash_dict</span><span class="p">(</span><span class="n">pjoin</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
            <span class="c1"># inefficient, but works.</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">collapsed_d</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">d</span>

    <span class="n">loc_incrementals</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">incrementals</span><span class="p">)</span>
    <span class="n">loc_colon_parsed</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">colon_parsed</span><span class="p">)</span>

    <span class="c1"># split out env.d defined incrementals..</span>
    <span class="c1"># update incrementals *and* colon parsed for colon_separated;</span>
    <span class="c1"># incrementals on its own is space separated.</span>

    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collapsed_d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;COLON_SEPARATED&quot;</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
            <span class="n">loc_colon_parsed</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="n">loc_incrementals</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loc_colon_parsed</span><span class="p">)</span>

    <span class="c1"># now space.</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collapsed_d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;SPACE_SEPARATED&quot;</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
            <span class="n">loc_incrementals</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="c1"># now reinterpret.</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">collapsed_d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">loc_incrementals</span><span class="p">:</span>
            <span class="n">collapsed_d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">loc_colon_parsed</span><span class="p">:</span>
            <span class="n">collapsed_d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">_f</span> <span class="k">for</span> <span class="n">_f</span> <span class="ow">in</span> <span class="n">iflatten_instance</span><span class="p">(</span>
                <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">)</span> <span class="k">if</span> <span class="n">_f</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">collapsed_d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">_f</span> <span class="k">for</span> <span class="n">_f</span> <span class="ow">in</span> <span class="n">iflatten_instance</span><span class="p">(</span>
                <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">)</span> <span class="k">if</span> <span class="n">_f</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">collapsed_d</span><span class="p">,</span> <span class="n">loc_incrementals</span><span class="p">,</span> <span class="n">loc_colon_parsed</span></div>


<div class="viewcode-block" id="string_collapse_envd"><a class="viewcode-back" href="../../../api/pkgcore.ebuild.triggers.html#pkgcore.ebuild.triggers.string_collapse_envd">[docs]</a><span class="k">def</span> <span class="nf">string_collapse_envd</span><span class="p">(</span><span class="n">envd_dict</span><span class="p">,</span> <span class="n">incrementals</span><span class="p">,</span> <span class="n">colon_incrementals</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;transform a passed in dict to strictly strings&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">envd_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">incrementals</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">colon_incrementals</span><span class="p">:</span>
            <span class="n">envd_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">envd_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">v</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">update_ldso</span><span class="p">(</span><span class="n">ld_search_path</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
    <span class="c1"># we do an atomic rename instead of open and write quick</span>
    <span class="c1"># enough (avoid the race iow)</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="s1">&#39;etc&#39;</span><span class="p">,</span> <span class="s1">&#39;ld.so.conf&#39;</span><span class="p">)</span>
    <span class="n">new_f</span> <span class="o">=</span> <span class="n">AtomicWriteFile</span><span class="p">(</span>
        <span class="n">fp</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="n">os_data</span><span class="o">.</span><span class="n">root_uid</span><span class="p">,</span> <span class="n">gid</span><span class="o">=</span><span class="n">os_data</span><span class="o">.</span><span class="n">root_uid</span><span class="p">,</span> <span class="n">perms</span><span class="o">=</span><span class="mo">0o644</span><span class="p">)</span>
    <span class="n">new_f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# automatically generated, edit env.d files instead</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">new_f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ld_search_path</span><span class="p">)</span>
    <span class="n">new_f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">perform_env_update</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">skip_ldso_update</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">d</span><span class="p">,</span> <span class="n">inc</span><span class="p">,</span> <span class="n">colon</span> <span class="o">=</span> <span class="n">collapse_envd</span><span class="p">(</span><span class="n">pjoin</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;etc/env.d&quot;</span><span class="p">))</span>

    <span class="n">l</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;LDPATH&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">l</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">skip_ldso_update</span><span class="p">:</span>
        <span class="n">update_ldso</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>

    <span class="n">string_collapse_envd</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">inc</span><span class="p">,</span> <span class="n">colon</span><span class="p">)</span>

    <span class="n">new_f</span> <span class="o">=</span> <span class="n">AtomicWriteFile</span><span class="p">(</span>
        <span class="n">pjoin</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;etc&quot;</span><span class="p">,</span> <span class="s2">&quot;profile.env&quot;</span><span class="p">),</span>
        <span class="n">uid</span><span class="o">=</span><span class="n">os_data</span><span class="o">.</span><span class="n">root_uid</span><span class="p">,</span> <span class="n">gid</span><span class="o">=</span><span class="n">os_data</span><span class="o">.</span><span class="n">root_gid</span><span class="p">,</span> <span class="n">perms</span><span class="o">=</span><span class="mo">0o644</span><span class="p">)</span>
    <span class="n">new_f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# autogenerated.  update env.d instead</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">new_f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;export </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">=&quot;</span><span class="si">{</span><span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="si">}</span><span class="s1">&quot;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
    <span class="n">new_f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">new_f</span> <span class="o">=</span> <span class="n">AtomicWriteFile</span><span class="p">(</span>
        <span class="n">pjoin</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;etc&quot;</span><span class="p">,</span> <span class="s2">&quot;profile.csh&quot;</span><span class="p">),</span>
        <span class="n">uid</span><span class="o">=</span><span class="n">os_data</span><span class="o">.</span><span class="n">root_uid</span><span class="p">,</span> <span class="n">gid</span><span class="o">=</span><span class="n">os_data</span><span class="o">.</span><span class="n">root_gid</span><span class="p">,</span> <span class="n">perms</span><span class="o">=</span><span class="mo">0o644</span><span class="p">)</span>
    <span class="n">new_f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# autogenerated, update env.d instead</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">new_f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;setenv </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">=&quot;</span><span class="si">{</span><span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="si">}</span><span class="s1">&quot;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
    <span class="n">new_f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<div class="viewcode-block" id="env_update"><a class="viewcode-back" href="../../../api/pkgcore.ebuild.triggers.html#pkgcore.ebuild.triggers.env_update">[docs]</a><span class="k">class</span> <span class="nc">env_update</span><span class="p">(</span><span class="n">triggers</span><span class="o">.</span><span class="n">base</span><span class="p">):</span>

    <span class="n">required_csets</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">priority</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">_hooks</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;post_unmerge&#39;</span><span class="p">,</span> <span class="s1">&#39;post_merge&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="env_update.trigger"><a class="viewcode-back" href="../../../api/pkgcore.ebuild.triggers.html#pkgcore.ebuild.triggers.env_update.trigger">[docs]</a>    <span class="k">def</span> <span class="nf">trigger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">engine</span><span class="p">):</span>
        <span class="n">perform_env_update</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span></div></div>


<span class="k">def</span> <span class="nf">simple_chksum_compare</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">chksums</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;size&quot;</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">chksums</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">o</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">o</span> <span class="o">!=</span> <span class="n">v</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="s2">&quot;size&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">chksums</span> <span class="ow">and</span> <span class="s2">&quot;size&quot;</span> <span class="ow">in</span> <span class="n">y</span><span class="o">.</span><span class="n">chksums</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">chksums</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">y</span><span class="o">.</span><span class="n">chksums</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">found</span>


<span class="k">def</span> <span class="nf">gen_config_protect_filter</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">extra_protects</span><span class="o">=</span><span class="p">(),</span> <span class="n">extra_disables</span><span class="o">=</span><span class="p">()):</span>
    <span class="n">collapsed_d</span><span class="p">,</span> <span class="n">inc</span><span class="p">,</span> <span class="n">colon</span> <span class="o">=</span> <span class="n">collapse_envd</span><span class="p">(</span><span class="n">pjoin</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="s2">&quot;etc/env.d&quot;</span><span class="p">))</span>
    <span class="n">collapsed_d</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;CONFIG_PROTECT&quot;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">extra_protects</span><span class="p">)</span>
    <span class="n">collapsed_d</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;CONFIG_PROTECT_MASK&quot;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">extra_disables</span><span class="p">)</span>

    <span class="n">r</span> <span class="o">=</span> <span class="p">[</span><span class="n">values</span><span class="o">.</span><span class="n">StrGlobMatch</span><span class="p">(</span><span class="n">normpath</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
         <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">stable_unique</span><span class="p">(</span><span class="n">collapsed_d</span><span class="p">[</span><span class="s2">&quot;CONFIG_PROTECT&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;/etc&quot;</span><span class="p">]))]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">OrRestriction</span><span class="p">(</span><span class="o">*</span><span class="n">r</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">neg</span> <span class="o">=</span> <span class="n">stable_unique</span><span class="p">(</span><span class="n">collapsed_d</span><span class="p">[</span><span class="s2">&quot;CONFIG_PROTECT_MASK&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">neg</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">StrGlobMatch</span><span class="p">(</span><span class="n">normpath</span><span class="p">(</span><span class="n">neg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span>
                                     <span class="n">negate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">OrRestriction</span><span class="p">(</span>
                <span class="n">negate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="o">*</span><span class="p">[</span><span class="n">values</span><span class="o">.</span><span class="n">StrGlobMatch</span><span class="p">(</span><span class="n">normpath</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
                  <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">neg</span><span class="p">)])</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">AndRestriction</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">r</span>


<span class="k">def</span> <span class="nf">gen_collision_ignore_filter</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">extra_ignores</span><span class="o">=</span><span class="p">()):</span>
    <span class="n">collapsed_d</span><span class="p">,</span> <span class="n">inc</span><span class="p">,</span> <span class="n">colon</span> <span class="o">=</span> <span class="n">collapse_envd</span><span class="p">(</span><span class="n">pjoin</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="s2">&quot;etc/env.d&quot;</span><span class="p">))</span>
    <span class="n">ignored</span> <span class="o">=</span> <span class="n">collapsed_d</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;COLLISION_IGNORE&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">ignored</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">extra_ignores</span><span class="p">)</span>
    <span class="n">ignored</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;*/.keep&quot;</span><span class="p">,</span> <span class="s2">&quot;*/.keep_*&quot;</span><span class="p">])</span>

    <span class="n">ignored</span> <span class="o">=</span> <span class="n">stable_unique</span><span class="p">(</span><span class="n">ignored</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ignored</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;/*&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="n">ignored</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ignored</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/*&quot;</span>
    <span class="n">ignored</span> <span class="o">=</span> <span class="p">[</span><span class="n">values</span><span class="o">.</span><span class="n">StrRegex</span><span class="p">(</span><span class="n">fnmatch</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
               <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">stable_unique</span><span class="p">(</span><span class="n">ignored</span><span class="p">)]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ignored</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ignored</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">values</span><span class="o">.</span><span class="n">OrRestriction</span><span class="p">(</span><span class="o">*</span><span class="n">ignored</span><span class="p">)</span>


<div class="viewcode-block" id="ConfigProtectInstall"><a class="viewcode-back" href="../../../api/pkgcore.ebuild.triggers.html#pkgcore.ebuild.triggers.ConfigProtectInstall">[docs]</a><span class="k">class</span> <span class="nc">ConfigProtectInstall</span><span class="p">(</span><span class="n">triggers</span><span class="o">.</span><span class="n">base</span><span class="p">):</span>

    <span class="n">required_csets</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;install_existing&#39;</span><span class="p">,</span> <span class="s1">&#39;install&#39;</span><span class="p">)</span>
    <span class="n">priority</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">_hooks</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;pre_merge&#39;</span><span class="p">,)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extra_protects</span><span class="o">=</span><span class="p">(),</span> <span class="n">extra_disables</span><span class="o">=</span><span class="p">()):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">renames</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_protects</span> <span class="o">=</span> <span class="n">extra_protects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_disables</span> <span class="o">=</span> <span class="n">extra_disables</span>

<div class="viewcode-block" id="ConfigProtectInstall.register"><a class="viewcode-back" href="../../../api/pkgcore.ebuild.triggers.html#pkgcore.ebuild.triggers.ConfigProtectInstall.register">[docs]</a>    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">engine</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">ConfigProtectInstall_restore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">renames</span><span class="p">)</span>
        <span class="n">t2</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span></div>

<div class="viewcode-block" id="ConfigProtectInstall.trigger"><a class="viewcode-back" href="../../../api/pkgcore.ebuild.triggers.html#pkgcore.ebuild.triggers.ConfigProtectInstall.trigger">[docs]</a>    <span class="k">def</span> <span class="nf">trigger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="n">existing_cset</span><span class="p">,</span> <span class="n">install_cset</span><span class="p">):</span>
        <span class="c1"># hackish, but it works.</span>
        <span class="n">protected_filter</span> <span class="o">=</span> <span class="n">gen_config_protect_filter</span><span class="p">(</span>
            <span class="n">engine</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_protects</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_disables</span><span class="p">)</span><span class="o">.</span><span class="n">match</span>
        <span class="n">ignore_filter</span> <span class="o">=</span> <span class="n">gen_collision_ignore_filter</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span><span class="o">.</span><span class="n">match</span>
        <span class="n">protected</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">existing_cset</span><span class="o">.</span><span class="n">iterfiles</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_filter</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">location</span><span class="p">)</span> <span class="ow">and</span> <span class="n">protected_filter</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">location</span><span class="p">):</span>
                <span class="n">replacement</span> <span class="o">=</span> <span class="n">install_cset</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">simple_chksum_compare</span><span class="p">(</span><span class="n">replacement</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
                    <span class="n">protected</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
                        <span class="n">pjoin</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span>
                              <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">location</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">)),</span>
                        <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">replacement</span><span class="o">.</span><span class="n">location</span><span class="p">),</span>
                                    <span class="n">replacement</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">dir_loc</span><span class="p">,</span> <span class="n">entries</span> <span class="ow">in</span> <span class="n">protected</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">updates</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">existing</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">listdir_files</span><span class="p">(</span><span class="n">dir_loc</span><span class="p">)</span>
                                  <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;._cfg&quot;</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="c1"># this shouldn&#39;t occur.</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">existing</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># ._cfg0000_filename</span>
                    <span class="n">count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">9</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;_&quot;</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span>
                    <span class="n">fn</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">10</span><span class="p">:]</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">updates</span><span class="p">:</span>
                    <span class="n">updates</span><span class="p">[</span><span class="n">fn</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">count</span><span class="p">,</span> <span class="n">fn</span><span class="p">))</span>

            <span class="c1"># now we rename.</span>
            <span class="k">for</span> <span class="n">fname</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
                <span class="c1"># check for any updates with the same chksums.</span>
                <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">cfg_count</span><span class="p">,</span> <span class="n">cfg_fname</span> <span class="ow">in</span> <span class="n">updates</span><span class="p">[</span><span class="n">fname</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">simple_chksum_compare</span><span class="p">(</span><span class="n">livefs</span><span class="o">.</span><span class="n">gen_obj</span><span class="p">(</span>
                            <span class="n">pjoin</span><span class="p">(</span><span class="n">dir_loc</span><span class="p">,</span> <span class="n">cfg_fname</span><span class="p">)),</span> <span class="n">entry</span><span class="p">):</span>
                        <span class="n">count</span> <span class="o">=</span> <span class="n">cfg_count</span>
                        <span class="k">break</span>
                    <span class="n">count</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">cfg_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">install_cset</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="c1"># this shouldn&#39;t occur...</span>
                    <span class="k">continue</span>
                <span class="n">new_fn</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="n">dir_loc</span><span class="p">,</span> <span class="s2">&quot;._cfg</span><span class="si">%04i</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">fname</span><span class="p">))</span>
                <span class="n">new_entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">change_attributes</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">new_fn</span><span class="p">)</span>
                <span class="n">install_cset</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_entry</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">renames</span><span class="p">[</span><span class="n">new_entry</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span>
            <span class="k">del</span> <span class="n">updates</span></div></div>


<span class="k">class</span> <span class="nc">ConfigProtectInstall_restore</span><span class="p">(</span><span class="n">triggers</span><span class="o">.</span><span class="n">base</span><span class="p">):</span>

    <span class="n">required_csets</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;install&#39;</span><span class="p">,)</span>
    <span class="n">priority</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">_hooks</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;post_merge&#39;</span><span class="p">,)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">renames_dict</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">renames</span> <span class="o">=</span> <span class="n">renames_dict</span>

    <span class="k">def</span> <span class="nf">trigger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="n">install_cset</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">new_entry</span><span class="p">,</span> <span class="n">old_entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">renames</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">install_cset</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">new_entry</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">install_cset</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">old_entry</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">renames</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>


<div class="viewcode-block" id="ConfigProtectUninstall"><a class="viewcode-back" href="../../../api/pkgcore.ebuild.triggers.html#pkgcore.ebuild.triggers.ConfigProtectUninstall">[docs]</a><span class="k">class</span> <span class="nc">ConfigProtectUninstall</span><span class="p">(</span><span class="n">triggers</span><span class="o">.</span><span class="n">base</span><span class="p">):</span>

    <span class="n">required_csets</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;uninstall_existing&#39;</span><span class="p">,</span> <span class="s1">&#39;uninstall&#39;</span><span class="p">)</span>
    <span class="n">_hooks</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;pre_unmerge&#39;</span><span class="p">,)</span>

<div class="viewcode-block" id="ConfigProtectUninstall.trigger"><a class="viewcode-back" href="../../../api/pkgcore.ebuild.triggers.html#pkgcore.ebuild.triggers.ConfigProtectUninstall.trigger">[docs]</a>    <span class="k">def</span> <span class="nf">trigger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="n">existing_cset</span><span class="p">,</span> <span class="n">uninstall_cset</span><span class="p">):</span>
        <span class="n">protected_filter</span> <span class="o">=</span> <span class="n">gen_config_protect_filter</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span><span class="o">.</span><span class="n">match</span>
        <span class="n">ignore_filter</span> <span class="o">=</span> <span class="n">gen_collision_ignore_filter</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span><span class="o">.</span><span class="n">match</span>

        <span class="n">remove</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">existing_cset</span><span class="o">.</span><span class="n">iterfiles</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_filter</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">location</span><span class="p">)</span> <span class="ow">and</span> <span class="n">protected_filter</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">location</span><span class="p">):</span>
                <span class="n">recorded_ent</span> <span class="o">=</span> <span class="n">uninstall_cset</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">simple_chksum_compare</span><span class="p">(</span><span class="n">recorded_ent</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
                        <span class="c1"># chksum differs.  file stays.</span>
                        <span class="n">remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recorded_ent</span><span class="p">)</span>
                <span class="c1"># If a file doesn&#39;t exist we don&#39;t need to remove it</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">NotADirectoryError</span><span class="p">):</span>
                    <span class="k">pass</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">remove</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">uninstall_cset</span><span class="p">[</span><span class="n">x</span><span class="p">]</span></div></div>


<span class="k">class</span> <span class="nc">UninstallIgnore</span><span class="p">(</span><span class="n">triggers</span><span class="o">.</span><span class="n">base</span><span class="p">):</span>

    <span class="n">required_csets</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">const</span><span class="o">.</span><span class="n">REPLACE_MODE</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;uninstall_existing&#39;</span><span class="p">,</span> <span class="s1">&#39;uninstall&#39;</span><span class="p">,</span> <span class="s1">&#39;old_cset&#39;</span><span class="p">),</span>
        <span class="n">const</span><span class="o">.</span><span class="n">UNINSTALL_MODE</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;uninstall_existing&#39;</span><span class="p">,</span> <span class="s1">&#39;uninstall&#39;</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="n">_hooks</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;pre_unmerge&#39;</span><span class="p">,)</span>
    <span class="n">_engine_types</span> <span class="o">=</span> <span class="n">triggers</span><span class="o">.</span><span class="n">UNINSTALLING_MODES</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uninstall_ignore</span><span class="o">=</span><span class="p">()):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uninstall_ignore</span> <span class="o">=</span> <span class="n">uninstall_ignore</span>

    <span class="k">def</span> <span class="nf">trigger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="n">existing_cset</span><span class="p">,</span> <span class="n">uninstall_cset</span><span class="p">,</span> <span class="n">old_cset</span><span class="o">=</span><span class="p">{}):</span>
        <span class="n">ignore</span> <span class="o">=</span> <span class="p">[</span><span class="n">values</span><span class="o">.</span><span class="n">StrRegex</span><span class="p">(</span><span class="n">fnmatch</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">match</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                  <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">uninstall_ignore</span><span class="p">]</span>
        <span class="n">ignore_filter</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">OrRestriction</span><span class="p">(</span><span class="o">*</span><span class="n">ignore</span><span class="p">)</span><span class="o">.</span><span class="n">match</span>

        <span class="n">remove</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">existing_cset</span><span class="o">.</span><span class="n">iterfiles</span><span class="p">()</span>
                  <span class="k">if</span> <span class="n">ignore_filter</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">location</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">remove</span><span class="p">:</span>
            <span class="c1"># don&#39;t remove matching files being uninstalled</span>
            <span class="k">del</span> <span class="n">uninstall_cset</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
            <span class="c1"># don&#39;t remove matching files being replaced</span>
            <span class="n">old_cset</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<div class="viewcode-block" id="preinst_contents_reset"><a class="viewcode-back" href="../../../api/pkgcore.ebuild.triggers.html#pkgcore.ebuild.triggers.preinst_contents_reset">[docs]</a><span class="k">class</span> <span class="nc">preinst_contents_reset</span><span class="p">(</span><span class="n">triggers</span><span class="o">.</span><span class="n">base</span><span class="p">):</span>

    <span class="n">required_csets</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;new_cset&#39;</span><span class="p">,)</span>
    <span class="n">priority</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">_hooks</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;pre_merge&#39;</span><span class="p">,)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">format_op</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">format_op</span> <span class="o">=</span> <span class="n">format_op</span>

<div class="viewcode-block" id="preinst_contents_reset.trigger"><a class="viewcode-back" href="../../../api/pkgcore.ebuild.triggers.html#pkgcore.ebuild.triggers.preinst_contents_reset.trigger">[docs]</a>    <span class="k">def</span> <span class="nf">trigger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="n">cset</span><span class="p">):</span>
        <span class="c1"># wipe, and get data again; ebuild preinst does untrackable</span>
        <span class="c1"># modifications to the fs</span>
        <span class="n">cset</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">cs</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">scan_contents</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format_op</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">engine</span><span class="o">.</span><span class="n">offset</span> <span class="o">!=</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
            <span class="n">cs</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">insert_offset</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>
        <span class="n">cset</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span></div></div>


<span class="k">class</span> <span class="nc">FileCollision</span><span class="p">(</span><span class="n">triggers</span><span class="o">.</span><span class="n">base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generic livefs file collision trigger.&quot;&quot;&quot;</span>

    <span class="n">required_csets</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">const</span><span class="o">.</span><span class="n">INSTALL_MODE</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;install&#39;</span><span class="p">,</span> <span class="s1">&#39;install_existing&#39;</span><span class="p">),</span>
        <span class="n">const</span><span class="o">.</span><span class="n">REPLACE_MODE</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;install&#39;</span><span class="p">,</span> <span class="s1">&#39;install_existing&#39;</span><span class="p">,</span> <span class="s1">&#39;old_cset&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">_hooks</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;sanity_check&#39;</span><span class="p">,)</span>
    <span class="n">_engine_types</span> <span class="o">=</span> <span class="n">triggers</span><span class="o">.</span><span class="n">INSTALLING_MODES</span>

    <span class="n">suppress_exceptions</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extra_protects</span><span class="o">=</span><span class="p">(),</span> <span class="n">extra_disables</span><span class="o">=</span><span class="p">(),</span> <span class="n">extra_ignores</span><span class="o">=</span><span class="p">()):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_protects</span> <span class="o">=</span> <span class="n">extra_protects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_disables</span> <span class="o">=</span> <span class="n">extra_disables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_ignores</span> <span class="o">=</span> <span class="n">extra_ignores</span>

    <span class="k">def</span> <span class="nf">collision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colliding</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle livefs file collisions.</span>

<span class="sd">        Must be overridden in derived trigger classes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">trigger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="n">install</span><span class="p">,</span> <span class="n">existing</span><span class="p">,</span> <span class="n">old_cset</span><span class="o">=</span><span class="p">()):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">existing</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># for the moment, we just care about files</span>
        <span class="n">colliding</span> <span class="o">=</span> <span class="n">existing</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">install</span><span class="o">.</span><span class="n">iterdirs</span><span class="p">())</span>

        <span class="c1"># hackish, but it works.</span>
        <span class="n">protected_filter</span> <span class="o">=</span> <span class="n">gen_config_protect_filter</span><span class="p">(</span>
            <span class="n">engine</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_protects</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_disables</span><span class="p">)</span><span class="o">.</span><span class="n">match</span>
        <span class="n">ignore_filter</span> <span class="o">=</span> <span class="n">gen_collision_ignore_filter</span><span class="p">(</span>
            <span class="n">engine</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_ignores</span><span class="p">)</span><span class="o">.</span><span class="n">match</span>

        <span class="n">ignores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">colliding</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">protected_filter</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">location</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ignore_filter</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">location</span><span class="p">):</span>
                <span class="n">ignores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">colliding</span><span class="o">.</span><span class="n">difference_update</span><span class="p">(</span><span class="n">ignores</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">colliding</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Wipe the references since we may throw an exception- we don&#39;t want</span>
        <span class="c1"># potentially millions of references being kept in memory for heavy</span>
        <span class="c1"># ignore matches.</span>
        <span class="k">del</span> <span class="n">ignores</span><span class="p">,</span> <span class="n">protected_filter</span><span class="p">,</span> <span class="n">ignore_filter</span>
        <span class="n">colliding</span><span class="o">.</span><span class="n">difference_update</span><span class="p">(</span><span class="n">old_cset</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">colliding</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collision</span><span class="p">(</span><span class="n">colliding</span><span class="p">)</span>


<div class="viewcode-block" id="CollisionProtect"><a class="viewcode-back" href="../../../api/pkgcore.ebuild.triggers.html#pkgcore.ebuild.triggers.CollisionProtect">[docs]</a><span class="k">class</span> <span class="nc">CollisionProtect</span><span class="p">(</span><span class="n">FileCollision</span><span class="p">):</span>

<div class="viewcode-block" id="CollisionProtect.collision"><a class="viewcode-back" href="../../../api/pkgcore.ebuild.triggers.html#pkgcore.ebuild.triggers.CollisionProtect.collision">[docs]</a>    <span class="k">def</span> <span class="nf">collision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colliding</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">BlockModification</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;collision-protect: file(s) already exist: ( </span><span class="si">%s</span><span class="s2"> )&quot;</span> <span class="o">%</span>
            <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">colliding</span><span class="p">)))</span></div></div>


<div class="viewcode-block" id="ProtectOwned"><a class="viewcode-back" href="../../../api/pkgcore.ebuild.triggers.html#pkgcore.ebuild.triggers.ProtectOwned">[docs]</a><span class="k">class</span> <span class="nc">ProtectOwned</span><span class="p">(</span><span class="n">FileCollision</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vdb</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vdb</span> <span class="o">=</span> <span class="n">vdb</span>

<div class="viewcode-block" id="ProtectOwned.collision"><a class="viewcode-back" href="../../../api/pkgcore.ebuild.triggers.html#pkgcore.ebuild.triggers.ProtectOwned.collision">[docs]</a>    <span class="k">def</span> <span class="nf">collision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colliding</span><span class="p">):</span>
        <span class="n">real_pkgs</span> <span class="o">=</span> <span class="p">(</span><span class="n">pkg</span> <span class="k">for</span> <span class="n">repo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vdb</span> <span class="k">for</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="n">repo</span> <span class="k">if</span> <span class="n">pkg</span><span class="o">.</span><span class="n">package_is_real</span><span class="p">)</span>
        <span class="n">collisions</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># TODO: worth parallelizing this vdb scanning?</span>
        <span class="k">for</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="n">real_pkgs</span><span class="p">:</span>
            <span class="n">pkg_file_collisions</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">colliding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pkg_file_collisions</span><span class="p">:</span>
                <span class="n">collisions</span><span class="p">[</span><span class="n">pkg</span><span class="o">.</span><span class="n">cpvstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">pkg_file_collisions</span>

        <span class="k">if</span> <span class="n">collisions</span><span class="p">:</span>
            <span class="n">pkg_collisions</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;( </span><span class="si">%s</span><span class="s2"> ) owned by &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span>
                <span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">collisions</span><span class="p">[</span><span class="n">pkg_cpvstr</span><span class="p">])),</span> <span class="n">pkg_cpvstr</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">pkg_cpvstr</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">collisions</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">BlockModification</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;protect-owned: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pkg_collisions</span><span class="p">),))</span></div></div>

        <span class="c1"># TODO: output a file override warning here</span>


<div class="viewcode-block" id="install_into_symdir_protect"><a class="viewcode-back" href="../../../api/pkgcore.ebuild.triggers.html#pkgcore.ebuild.triggers.install_into_symdir_protect">[docs]</a><span class="k">class</span> <span class="nc">install_into_symdir_protect</span><span class="p">(</span><span class="n">triggers</span><span class="o">.</span><span class="n">base</span><span class="p">):</span>

    <span class="n">required_csets</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">const</span><span class="o">.</span><span class="n">INSTALL_MODE</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;install&#39;</span><span class="p">,</span> <span class="s1">&#39;install_existing&#39;</span><span class="p">),</span>
        <span class="n">const</span><span class="o">.</span><span class="n">REPLACE_MODE</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;install&#39;</span><span class="p">,</span> <span class="s1">&#39;install_existing&#39;</span><span class="p">,</span> <span class="s1">&#39;old_cset&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">_hooks</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;sanity_check&#39;</span><span class="p">,)</span>
    <span class="n">_engine_types</span> <span class="o">=</span> <span class="n">triggers</span><span class="o">.</span><span class="n">INSTALLING_MODES</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extra_protects</span><span class="o">=</span><span class="p">(),</span> <span class="n">extra_disables</span><span class="o">=</span><span class="p">()):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_protects</span> <span class="o">=</span> <span class="n">extra_protects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_disables</span> <span class="o">=</span> <span class="n">extra_disables</span>

<div class="viewcode-block" id="install_into_symdir_protect.trigger"><a class="viewcode-back" href="../../../api/pkgcore.ebuild.triggers.html#pkgcore.ebuild.triggers.install_into_symdir_protect.trigger">[docs]</a>    <span class="k">def</span> <span class="nf">trigger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="n">install</span><span class="p">,</span> <span class="n">existing</span><span class="p">,</span> <span class="n">old_cset</span><span class="o">=</span><span class="p">()):</span>
        <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">existing</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># avoid generator madness</span>
        <span class="n">install_into_symdir</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">linkset</span> <span class="ow">in</span> <span class="p">[</span><span class="n">install</span><span class="o">.</span><span class="n">iterlinks</span><span class="p">(),</span> <span class="n">existing</span><span class="o">.</span><span class="n">iterlinks</span><span class="p">()]:</span>
            <span class="n">linkset</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">linkset</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">linkset</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">inst_file</span> <span class="ow">in</span> <span class="n">install</span><span class="o">.</span><span class="n">iterfiles</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">sym</span> <span class="ow">in</span> <span class="n">linkset</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">inst_file</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">sym</span><span class="o">.</span><span class="n">location</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">):</span>
                            <span class="n">install_into_symdir</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inst_file</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">install_into_symdir</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">BlockModification</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="s2">&quot;file(s) installed into symlinked dir, will break when &quot;</span>
                <span class="s2">&quot;removing files from the original dir: ( </span><span class="si">%s</span><span class="s2"> )&quot;</span> <span class="o">%</span>
                <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">install_into_symdir</span><span class="p">)))</span></div></div>


<div class="viewcode-block" id="InfoRegen"><a class="viewcode-back" href="../../../api/pkgcore.ebuild.triggers.html#pkgcore.ebuild.triggers.InfoRegen">[docs]</a><span class="k">class</span> <span class="nc">InfoRegen</span><span class="p">(</span><span class="n">triggers</span><span class="o">.</span><span class="n">InfoRegen</span><span class="p">):</span>

    <span class="n">_label</span> <span class="o">=</span> <span class="s2">&quot;ebuild info regen&quot;</span>

<div class="viewcode-block" id="InfoRegen.register"><a class="viewcode-back" href="../../../api/pkgcore.ebuild.triggers.html#pkgcore.ebuild.triggers.InfoRegen.register">[docs]</a>    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">engine</span><span class="p">):</span>
        <span class="c1"># wipe pre-existing info triggers.</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hooks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">engine</span><span class="o">.</span><span class="n">hooks</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># yucky, but works.</span>
            <span class="n">wipes</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">engine</span><span class="o">.</span><span class="n">hooks</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
                     <span class="k">if</span> <span class="n">y</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="n">triggers</span><span class="o">.</span><span class="n">InfoRegen</span><span class="o">.</span><span class="n">_label</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">wipes</span><span class="p">:</span>
                <span class="n">engine</span><span class="o">.</span><span class="n">hooks</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">triggers</span><span class="o">.</span><span class="n">InfoRegen</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span></div>

<div class="viewcode-block" id="InfoRegen.should_skip_directory"><a class="viewcode-back" href="../../../api/pkgcore.ebuild.triggers.html#pkgcore.ebuild.triggers.InfoRegen.should_skip_directory">[docs]</a>    <span class="k">def</span> <span class="nf">should_skip_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">basepath</span><span class="p">,</span> <span class="n">files</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;.keepinfodir&quot;</span><span class="p">)</span>
                   <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">files</span><span class="p">)</span></div>

<div class="viewcode-block" id="InfoRegen.trigger"><a class="viewcode-back" href="../../../api/pkgcore.ebuild.triggers.html#pkgcore.ebuild.triggers.InfoRegen.trigger">[docs]</a>    <span class="k">def</span> <span class="nf">trigger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="n">engine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span> <span class="s2">&quot;etc/env.d&quot;</span><span class="p">)</span>
        <span class="n">triggers</span><span class="o">.</span><span class="n">InfoRegen</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">locations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">collapsed_d</span> <span class="o">=</span> <span class="n">collapse_envd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">collapsed_d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;INFOPATH&quot;</span><span class="p">,</span> <span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">l</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">triggers</span><span class="o">.</span><span class="n">InfoRegen</span><span class="o">.</span><span class="n">locations</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">l</span></div>


<div class="viewcode-block" id="SFPerms"><a class="viewcode-back" href="../../../api/pkgcore.ebuild.triggers.html#pkgcore.ebuild.triggers.SFPerms">[docs]</a><span class="k">class</span> <span class="nc">SFPerms</span><span class="p">(</span><span class="n">triggers</span><span class="o">.</span><span class="n">base</span><span class="p">):</span>
    <span class="n">required_csets</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;new_cset&#39;</span><span class="p">,)</span>
    <span class="n">_hooks</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;pre_merge&#39;</span><span class="p">,)</span>
    <span class="n">_engine_types</span> <span class="o">=</span> <span class="n">triggers</span><span class="o">.</span><span class="n">INSTALLING_MODES</span>

<div class="viewcode-block" id="SFPerms.trigger"><a class="viewcode-back" href="../../../api/pkgcore.ebuild.triggers.html#pkgcore.ebuild.triggers.SFPerms.trigger">[docs]</a>    <span class="k">def</span> <span class="nf">trigger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="n">cset</span><span class="p">):</span>
        <span class="n">resets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cset</span><span class="o">.</span><span class="n">iterfiles</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="mo">0o4000</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="mo">0o044</span><span class="p">:</span>
                    <span class="n">engine</span><span class="o">.</span><span class="n">observer</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="s2">&quot;sfperms: dropping group/world read &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;due to SetGID: </span><span class="si">{</span><span class="n">x</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">resets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">change_attributes</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mo">0o44</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="mo">0o2000</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="mo">0o004</span><span class="p">:</span>
                    <span class="n">engine</span><span class="o">.</span><span class="n">observer</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;sfperms: dropping world read due to SetUID: </span><span class="si">{</span><span class="n">x</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">resets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">change_attributes</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mo">0o04</span><span class="p">))</span>
        <span class="n">cset</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">resets</span><span class="p">)</span></div></div>


<span class="k">def</span> <span class="nf">register_multilib_strict_trigger</span><span class="p">(</span><span class="n">opts</span><span class="p">):</span>
    <span class="n">locations</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;MULTILIB_STRICT_DIRS&quot;</span><span class="p">)</span>
    <span class="n">exempt</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;MULTILIB_STRICT_EXEMPT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;(perl5|gcc|gcc-lib)&quot;</span><span class="p">)</span>
    <span class="n">deny_pattern</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;MULTILIB_STRICT_DENY&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="p">(</span><span class="n">locations</span><span class="p">,</span> <span class="n">deny_pattern</span><span class="p">):</span>
        <span class="k">return</span>
    <span class="n">locations</span> <span class="o">=</span> <span class="n">locations</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">locations</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">locations</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">locations</span> <span class="o">=</span> <span class="n">locations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">locations</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">locations</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
    <span class="n">limit_pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">locations</span><span class="si">}</span><span class="s2">/(?!</span><span class="si">{</span><span class="n">exempt</span><span class="si">}</span><span class="s2">)&quot;</span>
    <span class="k">while</span> <span class="s2">&quot;//&quot;</span> <span class="ow">in</span> <span class="n">limit_pattern</span><span class="p">:</span>
        <span class="n">limit_pattern</span> <span class="o">=</span> <span class="n">limit_pattern</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;//&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="c1"># this seems semi dodgey, specifically, that it won&#39;t catch &#39;em all</span>
    <span class="n">trig</span> <span class="o">=</span> <span class="n">triggers</span><span class="o">.</span><span class="n">BlockFileType</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;.*</span><span class="si">{</span><span class="n">deny_pattern</span><span class="si">}</span><span class="s2">.*&quot;</span><span class="p">,</span> <span class="n">limit_pattern</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">trig</span>


<div class="viewcode-block" id="FixImageSymlinks"><a class="viewcode-back" href="../../../api/pkgcore.ebuild.triggers.html#pkgcore.ebuild.triggers.FixImageSymlinks">[docs]</a><span class="k">class</span> <span class="nc">FixImageSymlinks</span><span class="p">(</span><span class="n">triggers</span><span class="o">.</span><span class="n">base</span><span class="p">):</span>

    <span class="n">required_csets</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;new_cset&#39;</span><span class="p">,)</span>
    <span class="n">_hooks</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;pre_merge&#39;</span><span class="p">,)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">format_op</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">format_op</span> <span class="o">=</span> <span class="n">format_op</span>

<div class="viewcode-block" id="FixImageSymlinks.trigger"><a class="viewcode-back" href="../../../api/pkgcore.ebuild.triggers.html#pkgcore.ebuild.triggers.FixImageSymlinks.trigger">[docs]</a>    <span class="k">def</span> <span class="nf">trigger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="n">cset</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_op</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
        <span class="n">l</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cset</span><span class="o">.</span><span class="n">iterlinks</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">d</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">engine</span><span class="o">.</span><span class="n">observer</span><span class="p">:</span>
            <span class="n">o</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">observer</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                <span class="n">o</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;correcting </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">location</span><span class="si">}</span><span class="s2"> sym pointing into $D: </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">target</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">d_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="c1"># drop the leading ${D}, and force an abspath via &#39;/&#39;</span>
        <span class="n">cset</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="n">x</span><span class="o">.</span><span class="n">change_attributes</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">pjoin</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">target</span><span class="p">[</span><span class="n">d_len</span><span class="p">:]))</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="GenerateTriggers"><a class="viewcode-back" href="../../../api/pkgcore.ebuild.triggers.html#pkgcore.ebuild.triggers.GenerateTriggers">[docs]</a><span class="k">class</span> <span class="nc">GenerateTriggers</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opts</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Pop trigger-related options from the system config, they shouldn&#39;t be</span>
        <span class="c1"># needed anywhere else and doing so prevents them from leaking into the</span>
        <span class="c1"># ebuild env.</span>

        <span class="n">config_lists</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;CONFIG_PROTECT&quot;</span><span class="p">,</span> <span class="s2">&quot;CONFIG_PROTECT_MASK&quot;</span><span class="p">,</span> <span class="s2">&quot;COLLISION_IGNORE&quot;</span><span class="p">,</span>
            <span class="s2">&quot;INSTALL_MASK&quot;</span><span class="p">,</span> <span class="s2">&quot;UNINSTALL_IGNORE&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">config_lists</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

        <span class="n">config_opts</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;PKGDIR&quot;</span><span class="p">,</span>
            <span class="s2">&quot;MULTILIB_STRICT_DIRS&quot;</span><span class="p">,</span> <span class="s2">&quot;MULTILIB_STRICT_EXEMPT&quot;</span><span class="p">,</span> <span class="s2">&quot;MULTILIB_STRICT_DENY&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DEB_REPO_ROOT&quot;</span><span class="p">,</span> <span class="s2">&quot;DEB_MAINAINER&quot;</span><span class="p">,</span> <span class="s2">&quot;DEB_ARCHITECTURE&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">config_opts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">env_update</span><span class="p">()</span>

        <span class="k">yield</span> <span class="n">ConfigProtectInstall</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s2">&quot;CONFIG_PROTECT&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s2">&quot;CONFIG_PROTECT_MASK&quot;</span><span class="p">])</span>
        <span class="k">yield</span> <span class="n">ConfigProtectUninstall</span><span class="p">()</span>

        <span class="k">if</span> <span class="s2">&quot;collision-protect&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">CollisionProtect</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s2">&quot;CONFIG_PROTECT&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s2">&quot;CONFIG_PROTECT_MASK&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s2">&quot;COLLISION_IGNORE&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="s2">&quot;protect-owned&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">features</span> <span class="ow">and</span> <span class="s2">&quot;collision-protect&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">ProtectOwned</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">installed_repos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s2">&quot;CONFIG_PROTECT&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s2">&quot;CONFIG_PROTECT_MASK&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s2">&quot;COLLISION_IGNORE&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="s2">&quot;multilib-strict&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">register_multilib_strict_trigger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;sfperms&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">SFPerms</span><span class="p">()</span>

        <span class="k">yield</span> <span class="n">install_into_symdir_protect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s2">&quot;CONFIG_PROTECT&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s2">&quot;CONFIG_PROTECT_MASK&quot;</span><span class="p">])</span>

        <span class="c1"># TODO: support multiple binpkg repo targets?</span>
        <span class="n">pkgdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PKGDIR&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pkgdir</span><span class="p">:</span>
            <span class="n">target_repo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">binary_repos_raw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pkgdir</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># get the highest priority binpkg repo</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">target_repo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">binary_repos_raw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="n">target_repo</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">target_repo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;buildpkg&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">triggers</span><span class="o">.</span><span class="n">SavePkg</span><span class="p">(</span><span class="n">pristine</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">,</span> <span class="n">target_repo</span><span class="o">=</span><span class="n">target_repo</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;pristine-buildpkg&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">triggers</span><span class="o">.</span><span class="n">SavePkg</span><span class="p">(</span><span class="n">pristine</span><span class="o">=</span><span class="s1">&#39;yes&#39;</span><span class="p">,</span> <span class="n">target_repo</span><span class="o">=</span><span class="n">target_repo</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;buildsyspkg&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">triggers</span><span class="o">.</span><span class="n">SavePkgIfInPkgset</span><span class="p">(</span>
                    <span class="n">pristine</span><span class="o">=</span><span class="s1">&#39;yes&#39;</span><span class="p">,</span> <span class="n">target_repo</span><span class="o">=</span><span class="n">target_repo</span><span class="p">,</span> <span class="n">pkgset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">system</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;unmerge-backup&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">triggers</span><span class="o">.</span><span class="n">SavePkgUnmerging</span><span class="p">(</span><span class="n">target_repo</span><span class="o">=</span><span class="n">target_repo</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;splitdebug&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">triggers</span><span class="o">.</span><span class="n">BinaryDebug</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;compressdebug&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">features</span><span class="p">))</span>
        <span class="k">elif</span> <span class="s1">&#39;strip&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">features</span> <span class="ow">or</span> <span class="s1">&#39;nostrip&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">triggers</span><span class="o">.</span><span class="n">BinaryDebug</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;strip&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;-fixlafiles&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">libtool</span><span class="o">.</span><span class="n">FixLibtoolArchivesTrigger</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;man&quot;</span><span class="p">,</span> <span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="s2">&quot;doc&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;no</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s2">&quot;INSTALL_MASK&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/usr/share/</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">l</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s2">&quot;INSTALL_MASK&quot;</span><span class="p">]:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">StrRegex</span><span class="p">(</span><span class="n">fnmatch</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
            <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">StrRegex</span><span class="p">(</span><span class="n">fnmatch</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">/*&quot;</span><span class="p">)))</span>
        <span class="n">install_mask</span> <span class="o">=</span> <span class="n">l</span>

        <span class="k">if</span> <span class="n">install_mask</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">install_mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">install_mask</span> <span class="o">=</span> <span class="n">install_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">install_mask</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">OrRestriction</span><span class="p">(</span><span class="o">*</span><span class="n">install_mask</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">triggers</span><span class="o">.</span><span class="n">PruneFiles</span><span class="p">(</span><span class="n">install_mask</span><span class="o">.</span><span class="n">match</span><span class="p">)</span>
            <span class="c1"># note that if this wipes all /usr/share/ entries, should</span>
            <span class="c1"># wipe the empty dir.</span>

        <span class="k">yield</span> <span class="n">UninstallIgnore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s2">&quot;UNINSTALL_IGNORE&quot;</span><span class="p">])</span>
        <span class="k">yield</span> <span class="n">InfoRegen</span><span class="p">()</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">pkgcore trunk documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">pkgcore.ebuild.triggers</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2006-2019, pkgcore contributors.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.5.0.
    </div>
  </body>
</html>